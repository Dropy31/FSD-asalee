<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https: data: 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:;">
    <title>Suivi Diabète - Desktop Secure</title>
    <!-- Local Libraries -->
    <link rel="stylesheet" href="tailwind_build.css">
    <link rel="stylesheet" href="libs/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="libs/chartjs/chart.umd.js"></script>
    <script src="libs/chartjs-adapter/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>

<body class="bg-gray-100 font-sans h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-800 text-white flex flex-col shadow-lg">
        <div class="p-6 border-b border-slate-700 flex items-center gap-3">
            <i class="fas fa-heartbeat text-2xl text-blue-400"></i>
            <h1 class="text-xl font-bold tracking-wide">Diabète<span class="text-blue-400">Suivi</span></h1>
        </div>

        <div id="active-patient-banner" class="hidden bg-slate-700 p-4 border-b border-slate-600 animate-fade-in">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xs text-blue-300 uppercase font-semibold tracking-wider">Dossier en cours</span>
                <button id="btn-close-patient" class="text-slate-400 hover:text-white transition-colors"
                    title="Fermer le dossier">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex items-center gap-2">
                <i class="fas fa-user-circle text-white text-lg"></i>
                <span id="active-patient-name" class="font-medium text-white truncate">--</span>
            </div>
            <!-- Badges Container moved here -->
            <div id="protocol-badges" class="flex flex-nowrap overflow-hidden gap-1 mt-2 empty:hidden pl-3"></div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 space-y-6">
            <!-- SECTION: GENERAL -->
            <div>
                <h3 class="px-6 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Général</h3>
                <ul class="space-y-1">
                    <li>
                        <button
                            class="nav-btn active w-full flex items-center gap-3 pl-10 pr-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors text-sm font-medium text-left"
                            data-target="dashboard">
                            <i class="fas fa-users w-6 text-center"></i> Patients
                        </button>
                    </li>
                    <li>
                        <button
                            class="nav-btn w-full flex items-center gap-3 pl-10 pr-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors text-sm font-medium text-left"
                            data-target="etp-library">
                            <i class="fas fa-book-medical w-6 text-center"></i> Bibliothèque
                        </button>
                    </li>
                    <li>
                    <li>
                        <button
                            class="nav-btn w-full flex items-center gap-3 pl-10 pr-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors text-sm font-medium text-left"
                            data-target="pharma-book">
                            <i class="fas fa-pills w-6 text-center"></i> Livret Pharmaceutique
                        </button>
                    </li>
                    <li>
                        <button
                            class="nav-btn w-full flex items-center gap-3 pl-10 pr-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors text-sm font-medium text-left"
                            data-target="templates">
                            <i class="fas fa-file-alt w-6 text-center"></i> Modèles
                        </button>
                    </li>
                </ul>
            </div>

            <!-- SECTION: PATIENT -->
            <div>
                <h3 class="px-6 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Dossier Patient</h3>
                <ul class="space-y-1">
                    <li>
                        <button
                            class="nav-btn patient-nav-btn w-full flex items-center gap-3 pl-10 pr-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors text-sm font-medium text-left relative"
                            data-target="identity-protocols">
                            <i class="fas fa-id-card w-6 text-center"></i> Identité & Protocoles
                        </button>
                    </li>
                    <li id="nav-item-profile" class="hidden">
                        <button
                            class="nav-btn patient-nav-btn w-full flex items-center gap-3 pl-10 pr-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors text-sm font-medium text-left relative"
                            data-target="patient-profile">
                            <i class="fas fa-heartbeat w-6 text-center"></i> Profil Médical
                            <i id="identity-alert-icon"
                                class="fas fa-exclamation-circle text-red-500 absolute right-4 hidden animate-pulse"
                                title="Mise à jour automatique: Néphropathie"></i>
                        </button>
                    </li>
                    <li id="nav-item-followup" class="hidden">
                        <button
                            class="nav-btn patient-nav-btn w-full flex items-center gap-3 pl-10 pr-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors text-sm font-medium text-left"
                            data-target="followup">
                            <i class="fas fa-chart-line w-6 text-center"></i> Suivi Biologique
                        </button>
                    </li>
                    <li id="nav-item-exams" class="hidden">
                        <button
                            class="nav-btn patient-nav-btn w-full flex items-center gap-3 pl-10 pr-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors text-sm font-medium text-left"
                            data-target="exams">
                            <i class="fas fa-calendar-check w-6 text-center"></i> Examens
                        </button>
                    </li>
                    <li id="nav-item-treatments" class="hidden">
                        <button
                            class="nav-btn patient-nav-btn w-full flex items-center gap-3 pl-10 pr-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors text-sm font-medium text-left"
                            data-target="treatments">
                            <i class="fas fa-prescription-bottle-alt w-6 text-center"></i> Traitements
                        </button>
                    </li>
                    <li id="nav-item-education" class="hidden">
                        <button
                            class="nav-btn patient-nav-btn w-full flex items-center gap-3 pl-10 pr-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors text-sm font-medium text-left"
                            data-target="education">
                            <i class="fas fa-graduation-cap w-6 text-center"></i> ETP
                        </button>
                    </li>
                    <li id="nav-item-synthesis" class="hidden">
                        <button
                            class="nav-btn patient-nav-btn w-full flex items-center gap-3 pl-10 pr-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors text-sm font-medium text-left"
                            data-target="synthesis">
                            <i class="fas fa-chart-pie w-6 text-center"></i> Synthèse
                        </button>
                    </li>
                    <li>
                        <button
                            class="nav-btn patient-nav-btn w-full flex items-center gap-3 pl-10 pr-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors text-sm font-medium text-left"
                            data-target="letters">
                            <i class="fas fa-envelope-open-text w-6 text-center"></i> Courriers
                        </button>
                    </li>
                </ul>
            </div>

            <!-- SECTION: SPECIFIC PROTOCOLS -->
            <div id="section-protocols" class="hidden">
                <h3 class="px-6 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 mt-6">Protocoles
                    Spécifiques</h3>
                <ul class="space-y-1">
                    <li id="nav-item-respiratory" class="hidden">
                        <button
                            class="nav-btn patient-nav-btn w-full flex items-center gap-3 pl-10 pr-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors text-sm font-medium text-left"
                            data-target="respiratory">
                            <i class="fas fa-lungs w-6 text-center"></i> Respiratoire
                        </button>
                    </li>
                    <li id="nav-item-cognitive" class="hidden">
                        <button
                            class="nav-btn patient-nav-btn w-full flex items-center gap-3 pl-10 pr-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors text-sm font-medium text-left"
                            data-target="cognitive">
                            <i class="fas fa-brain w-6 text-center"></i> Cognitif
                        </button>
                    </li>
                    <li id="nav-item-prevention" class="hidden">
                        <button
                            class="nav-btn patient-nav-btn w-full flex items-center gap-3 pl-10 pr-6 py-3 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors text-sm font-medium text-left"
                            data-target="prevention">
                            <i class="fas fa-shield-alt w-6 text-center"></i> Prévention
                        </button>
                    </li>
                </ul>
            </div>
            </ul>
            </div>
        </nav>

        <div class="p-4 border-t border-slate-700">
            <div class="flex items-center gap-3 text-sm text-slate-400">
                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                <span>Mode Sécurisé</span>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden">
        <!-- Top Bar -->
        <header class="bg-white shadow-sm h-16 flex items-center justify-between px-6 z-10">
            <h2 id="page-title" class="text-xl font-semibold text-gray-800">Tableau de Bord</h2>
            <div class="flex items-center gap-4">

                <button id="btn-new-patient"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors">
                    <i class="fas fa-plus mr-1"></i> Nouveau Patient
                </button>
                <div class="h-8 w-px bg-gray-200"></div>
                <div class="flex items-center gap-2">
                    <div
                        class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">
                        Dr
                    </div>
                    <span class="text-sm font-medium text-gray-700">Médecin</span>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <div id="content-area" class="flex-1 overflow-y-auto p-6 bg-gray-50 relative">

            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="view-section">
                <!-- Search Bar -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-8 flex gap-4 items-center">
                    <div class="flex-1 relative">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="dashboard-search" placeholder="Rechercher un patient (Nom, Prénom...)"
                            class="w-full !pl-12 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-100 focus:border-blue-400 transition-all">
                    </div>
                </div>

                <!-- Recent Patients -->
                <div class="mb-8 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Derniers Patients Consultés</h3>
                    <table class="w-full text-left text-sm text-gray-600">
                        <thead class="bg-gray-50 text-xs uppercase font-semibold text-gray-500">
                            <tr>
                                <th class="px-4 py-3">Nom</th>
                                <th class="px-4 py-3">Prénom</th>
                                <th class="px-4 py-3">Âge</th>
                                <th class="px-4 py-3">Médecin</th>
                                <th class="px-4 py-3">Dernière Consultation</th>
                                <th class="px-4 py-3 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-recent-patients" class="divide-y divide-gray-100">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>

                <!-- All Patients List -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Tous les Patients</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-50 text-xs uppercase font-semibold text-gray-500">
                                <tr>
                                    <th class="px-4 py-3 cursor-pointer hover:text-blue-600 transition-colors"
                                        id="sort-name">
                                        Nom <i class="fas fa-sort ml-1"></i>
                                    </th>
                                    <th class="px-4 py-3">Prénom</th>
                                    <th class="px-4 py-3">Âge</th>
                                    <th class="px-4 py-3">Médecin</th>
                                    <th class="px-4 py-3">Dernière Consultation</th>
                                    <th class="px-4 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="table-all-patients" class="divide-y divide-gray-100">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: PATIENT PROFILE (Risks) -->
            <div id="view-patient-profile" class="view-section hidden">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 max-w-7xl mx-auto">
                    <div class="flex justify-between items-center mb-8 border-b pb-4">
                        <h3 class="text-xl font-bold text-gray-800">Profil Médical & Facteurs de Risque</h3>
                    </div>
                    <form id="form-profile" class="space-y-8">

                        <!-- SECTION 2: RISKS & COMPLICATIONS (New Layout) -->
                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                            <!-- SECTION 1: DIABETES HISTORY (Moved here) -->
                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-6 flex items-center gap-6">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-history text-blue-500"></i>
                                    <h4 class="font-bold text-blue-800">Historique Diabète</h4>
                                </div>

                                <div class="flex items-center gap-4">
                                    <div class="flex items-center gap-2">
                                        <label class="text-sm font-medium text-blue-700">Année Diagnostic :</label>
                                        <input type="number" id="inp-diagnosis-year"
                                            class="w-24 bg-white border-blue-200 rounded-lg p-1.5 border text-sm focus:ring-2 focus:ring-blue-200 focus:border-blue-400 font-semibold text-center"
                                            placeholder="AAAA">
                                    </div>

                                    <div class="h-8 w-px bg-blue-200"></div>

                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-bold text-blue-600 uppercase">Ancienneté :</span>
                                        <span id="calc-duration" class="text-lg font-bold text-blue-900">--</span>
                                    </div>
                                </div>
                            </div>

                            <h4 class="text-lg font-semibold text-gray-700 mb-6 flex items-center gap-2">
                                <i class="fas fa-heartbeat text-red-500"></i> Profil de Risque & Complications
                            </h4>

                            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                                <!-- Column 1: Facteurs de Risque CV -->
                                <div class="space-y-4">
                                    <h5 class="font-bold text-gray-800 border-b pb-2">Facteurs de Risque CV</h5>

                                    <!-- HTA -->
                                    <div class="space-y-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <label class="text-xs font-semibold text-gray-500 uppercase">HTA</label>
                                            <div class="group relative">
                                                <i
                                                    class="fas fa-info-circle text-gray-400 hover:text-blue-500 cursor-help text-[10px]"></i>
                                                <div
                                                    class="invisible group-hover:visible absolute z-50 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 bottom-full left-1/2 transform -translate-x-1/2 mb-2 pointer-events-none text-center">
                                                    TA > 140/90 mmHg confirmée, ou patient traité pour HTA.
                                                    <div
                                                        class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <select id="risk-hta"
                                            class="w-full bg-gray-50 border-gray-200 rounded-full text-sm py-1 px-3 focus:ring-2 focus:ring-blue-200">
                                            <option value="NON">NON</option>
                                            <option value="OUI">OUI</option>
                                        </select>
                                    </div>

                                    <!-- Dyslipidémie -->
                                    <div class="space-y-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <label
                                                class="text-xs font-semibold text-gray-500 uppercase">Dyslipidémie</label>
                                            <div class="group relative">
                                                <i
                                                    class="fas fa-info-circle text-gray-400 hover:text-blue-500 cursor-help text-[10px]"></i>
                                                <div
                                                    class="invisible group-hover:visible absolute z-50 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 bottom-full left-1/2 transform -translate-x-1/2 mb-2 pointer-events-none text-center">
                                                    Anomalie du bilan lipidique (LDL, HDL, TG) ou patient traité.
                                                    <div
                                                        class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <select id="risk-dyslipidemia"
                                            class="w-full bg-gray-50 border-gray-200 rounded-full text-sm py-1 px-3 focus:ring-2 focus:ring-blue-200">
                                            <option value="NON">NON</option>
                                            <option value="OUI">OUI</option>
                                        </select>
                                    </div>

                                    <!-- Tabagisme -->
                                    <div class="space-y-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <label
                                                class="text-xs font-semibold text-gray-500 uppercase">Tabagisme</label>
                                            <div class="group relative">
                                                <i
                                                    class="fas fa-info-circle text-gray-400 hover:text-blue-500 cursor-help text-[10px]"></i>
                                                <div
                                                    class="invisible group-hover:visible absolute z-50 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 bottom-full left-1/2 transform -translate-x-1/2 mb-2 pointer-events-none text-center">
                                                    Fumeur actuel ou sevré depuis moins de 2 ans.
                                                    <div
                                                        class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <select id="risk-tobacco"
                                            class="w-full bg-gray-50 border-gray-200 rounded-full text-sm py-1 px-3 focus:ring-2 focus:ring-blue-200">
                                            <option value="NON">NON</option>
                                            <option value="OUI">OUI</option>
                                            <option value="SEVRE">SEVRÉ</option>
                                        </select>
                                    </div>

                                    <!-- Hérédité CV -->
                                    <div class="space-y-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <label class="text-xs font-semibold text-gray-500 uppercase">Hérédité
                                                CV</label>
                                            <div class="group relative">
                                                <i
                                                    class="fas fa-info-circle text-gray-400 hover:text-blue-500 cursor-help text-[10px]"></i>
                                                <div
                                                    class="invisible group-hover:visible absolute z-50 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 bottom-full left-1/2 transform -translate-x-1/2 mb-2 pointer-events-none text-center">
                                                    IDM ou mort subite chez un parent du 1er degré: père < 55 ans ou
                                                        mère < 65 ans. <div
                                                        class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <select id="risk-heredity"
                                        class="w-full bg-gray-50 border-gray-200 rounded-full text-sm py-1 px-3 focus:ring-2 focus:ring-blue-200">
                                        <option value="NON">NON</option>
                                        <option value="OUI">OUI</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Column 2: Macrovasculaire -->
                            <div class="space-y-4">
                                <h5 class="font-bold text-gray-800 border-b pb-2">Macrovasculaire</h5>

                                <!-- AVC / AIT -->
                                <div class="space-y-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="text-xs font-semibold text-gray-500 uppercase">AVC / AIT</label>
                                        <div class="group relative">
                                            <i
                                                class="fas fa-info-circle text-gray-400 hover:text-blue-500 cursor-help text-[10px]"></i>
                                            <div
                                                class="invisible group-hover:visible absolute z-50 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 bottom-full left-1/2 transform -translate-x-1/2 mb-2 pointer-events-none text-center">
                                                AVC: Lésion cérébrale permanente. AIT: Symptômes neurologiques
                                                régressifs en <24h, sans séquelle à l'imagerie. <div
                                                    class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <select id="macro-avc"
                                    class="w-full bg-gray-50 border-gray-200 rounded-full text-sm py-1 px-3 focus:ring-2 focus:ring-blue-200">
                                    <option value="NON">NON</option>
                                    <option value="OUI">OUI</option>
                                </select>
                            </div>

                            <!-- Coronaropathie -->
                            <div class="space-y-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Coronaropathie</label>
                                    <div class="group relative">
                                        <i
                                            class="fas fa-info-circle text-gray-400 hover:text-blue-500 cursor-help text-[10px]"></i>
                                        <div
                                            class="invisible group-hover:visible absolute z-50 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 bottom-full left-1/2 transform -translate-x-1/2 mb-2 pointer-events-none text-center">
                                            Stentée: Angioplastie coronaire avec pose de stent. Pontée: Chirurgie de
                                            pontage aorto-coronarien.
                                            <div
                                                class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <select id="macro-coronary"
                                    class="w-full bg-gray-50 border-gray-200 rounded-full text-sm py-1 px-3 focus:ring-2 focus:ring-blue-200">
                                    <option value="NON">NON</option>
                                    <option value="OUI">OUI</option>
                                </select>
                            </div>

                            <!-- AOMI -->
                            <div class="space-y-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="text-xs font-semibold text-gray-500 uppercase">AOMI</label>
                                    <div class="group relative">
                                        <i
                                            class="fas fa-info-circle text-gray-400 hover:text-blue-500 cursor-help text-[10px]"></i>
                                        <div
                                            class="invisible group-hover:visible absolute z-50 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 bottom-full left-1/2 transform -translate-x-1/2 mb-2 pointer-events-none text-center">
                                            Classification de Leriche et Fontaine. Stade 1: Asymptomatique. Stade 2:
                                            Claudication. Stade 3: Douleurs de repos. Stade 4: Troubles trophiques.
                                            <div
                                                class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <select id="macro-aomi"
                                    class="w-full bg-gray-50 border-gray-200 rounded-full text-sm py-1 px-3 focus:ring-2 focus:ring-blue-200">
                                    <option value="NON">NON</option>
                                    <option value="OUI">OUI</option>
                                </select>
                            </div>

                            <!-- Sténose Carotidienne -->
                            <div class="space-y-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Sténose
                                        Carotidienne</label>
                                    <div class="group relative">
                                        <i
                                            class="fas fa-info-circle text-gray-400 hover:text-blue-500 cursor-help text-[10px]"></i>
                                        <div
                                            class="invisible group-hover:visible absolute z-50 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 bottom-full left-1/2 transform -translate-x-1/2 mb-2 pointer-events-none text-center">
                                            Non serrée: 50-69%. Serrée: ≥70%. Ocluse: absence de flux détectable.
                                            <div
                                                class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <select id="macro-stenosis"
                                    class="w-full bg-gray-50 border-gray-200 rounded-full text-sm py-1 px-3 focus:ring-2 focus:ring-blue-200">
                                    <option value="NON">NON</option>
                                    <option value="OUI">OUI</option>
                                </select>
                            </div>
                        </div>

                        <!-- Column 3: Microvasculaire -->
                        <div class="space-y-4">
                            <h5 class="font-bold text-gray-800 border-b pb-2">Microvasculaire</h5>

                            <!-- Rétinopathie -->
                            <div class="space-y-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Rétinopathie</label>
                                    <div class="group relative">
                                        <i
                                            class="fas fa-info-circle text-gray-400 hover:text-blue-500 cursor-help text-[10px]"></i>
                                        <div
                                            class="invisible group-hover:visible absolute z-50 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 bottom-full left-1/2 transform -translate-x-1/2 mb-2 pointer-events-none text-center">
                                            RDNP: Non Proliférante. RDP: Proliférante. Compliquée: Maculopathie,
                                            Hémorragie Intra-Vitréenne (HIV), Décollement de Rétine (DR), Glaucome
                                            néo-vasculaire (GNV).
                                            <div
                                                class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <select id="micro-retino"
                                    class="w-full bg-gray-50 border-gray-200 rounded-full text-sm py-1 px-3 focus:ring-2 focus:ring-blue-200">
                                    <option value="NON">NON</option>
                                    <option value="OUI">OUI</option>
                                </select>
                            </div>

                            <!-- Néphropathie -->
                            <div class="space-y-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Néphropathie</label>
                                    <div class="group relative">
                                        <i
                                            class="fas fa-info-circle text-gray-400 hover:text-blue-500 cursor-help text-[10px]"></i>
                                        <div
                                            class="invisible group-hover:visible absolute z-50 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 bottom-full left-1/2 transform -translate-x-1/2 mb-2 pointer-events-none text-center">
                                            Classification selon le Débit de Filtration Glomérulaire (DFG) et la
                                            présence d'albuminurie (RAC).
                                            <div
                                                class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <select id="micro-nephro"
                                    class="w-full bg-gray-50 border-gray-200 rounded-full text-sm py-1 px-3 focus:ring-2 focus:ring-blue-200">
                                    <option value="NON">NON</option>
                                    <option value="OUI">OUI</option>
                                </select>
                            </div>

                            <!-- Neuro. Sensitive -->
                            <div class="space-y-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Neuro.
                                        Sensitive</label>
                                    <div class="group relative">
                                        <i
                                            class="fas fa-info-circle text-gray-400 hover:text-blue-500 cursor-help text-[10px]"></i>
                                        <div
                                            class="invisible group-hover:visible absolute z-50 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 bottom-full left-1/2 transform -translate-x-1/2 mb-2 pointer-events-none text-center">
                                            Perte de sensibilité (test au monofilament), paresthésies, douleurs
                                            (brûlures, décharges).
                                            <div
                                                class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <select id="micro-neuro-sens"
                                    class="w-full bg-gray-50 border-gray-200 rounded-full text-sm py-1 px-3 focus:ring-2 focus:ring-blue-200">
                                    <option value="NON">NON</option>
                                    <option value="OUI">OUI</option>
                                </select>
                            </div>

                            <!-- Neuro. Autonome -->
                            <div class="space-y-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Neuro. Autonome</label>
                                    <div class="group relative">
                                        <i
                                            class="fas fa-info-circle text-gray-400 hover:text-blue-500 cursor-help text-[10px]"></i>
                                        <div
                                            class="invisible group-hover:visible absolute z-50 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 bottom-full left-1/2 transform -translate-x-1/2 mb-2 pointer-events-none text-center">
                                            Atteinte du système nerveux involontaire. Peut causer: hypotension
                                            orthostatique, gastroparésie, troubles vésicaux, dysfonction érectile.
                                            <div
                                                class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <select id="micro-neuro-auto"
                                    class="w-full bg-gray-50 border-gray-200 rounded-full text-sm py-1 px-3 focus:ring-2 focus:ring-blue-200">
                                    <option value="NON">NON</option>
                                    <option value="OUI">OUI</option>
                                </select>
                            </div>
                        </div>

                        <!-- Column 4: Autres Complications -->
                        <div class="space-y-4">
                            <h5 class="font-bold text-gray-800 border-b pb-2">Autres</h5>

                            <!-- Insuffisance Cardiaque -->
                            <div class="space-y-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Insuffisance
                                        Cardiaque</label>
                                    <div class="group relative">
                                        <i
                                            class="fas fa-info-circle text-gray-400 hover:text-blue-500 cursor-help text-[10px]"></i>
                                        <div
                                            class="invisible group-hover:visible absolute z-50 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 bottom-full left-1/2 transform -translate-x-1/2 mb-2 pointer-events-none text-center">
                                            FEVG: Fraction d'Éjection du Ventricule Gauche. Pourcentage de sang éjecté à
                                            chaque battement. Normale >50%.
                                            <div
                                                class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <select id="other-hf"
                                    class="w-full bg-gray-50 border-gray-200 rounded-full text-sm py-1 px-3 focus:ring-2 focus:ring-blue-200">
                                    <option value="NON">NON</option>
                                    <option value="OUI">OUI</option>
                                </select>
                            </div>

                            <!-- Fibrillation Atriale -->
                            <div class="space-y-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Fibrillation
                                        Atriale</label>
                                    <div class="group relative">
                                        <i
                                            class="fas fa-info-circle text-gray-400 hover:text-blue-500 cursor-help text-[10px]"></i>
                                        <div
                                            class="invisible group-hover:visible absolute z-50 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 bottom-full left-1/2 transform -translate-x-1/2 mb-2 pointer-events-none text-center">
                                            Rythme cardiaque irrégulier et rapide, augmentant le risque d'AVC.
                                            <div
                                                class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <select id="other-afib"
                                    class="w-full bg-gray-50 border-gray-200 rounded-full text-sm py-1 px-3 focus:ring-2 focus:ring-blue-200">
                                    <option value="NON">NON</option>
                                    <option value="OUI">OUI</option>
                                </select>
                            </div>

                            <!-- Risque Pied -->
                            <div class="space-y-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Risque Pied</label>
                                    <div class="group relative">
                                        <i
                                            class="fas fa-info-circle text-gray-400 hover:text-blue-500 cursor-help text-[10px]"></i>
                                        <div
                                            class="invisible group-hover:visible absolute z-50 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 bottom-full left-1/2 transform -translate-x-1/2 mb-2 pointer-events-none text-center">
                                            Grade 0: Normal. G1: Neuropathie. G2: Neuro+AOMI/Déformation. G3: ATCD
                                            ulcère/amputation.
                                            <div
                                                class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <select id="other-foot"
                                    class="w-full bg-gray-50 border-gray-200 rounded-full text-sm py-1 px-3 focus:ring-2 focus:ring-blue-200">
                                    <option value="Grade 0">Grade 0</option>
                                    <option value="Grade 1">Grade 1</option>
                                    <option value="Grade 2">Grade 2</option>
                                    <option value="Grade 3">Grade 3</option>
                                </select>
                            </div>

                            <!-- Atteinte Hépatique -->
                            <div class="space-y-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Atteinte
                                        Hépatique</label>
                                    <div class="group relative">
                                        <i
                                            class="fas fa-info-circle text-gray-400 hover:text-blue-500 cursor-help text-[10px]"></i>
                                        <div
                                            class="invisible group-hover:visible absolute z-50 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 bottom-full left-1/2 transform -translate-x-1/2 mb-2 pointer-events-none text-center">
                                            NAFLD/NASH: Surcharge en graisse du foie, avec ou sans inflammation, liée au
                                            syndrome métabolique.
                                            <div
                                                class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <select id="other-liver"
                                    class="w-full bg-gray-50 border-gray-200 rounded-full text-sm py-1 px-3 focus:ring-2 focus:ring-blue-200">
                                    <option value="NON">NON</option>
                                    <option value="Steatose">Stéatose</option>
                                    <option value="NASH">NASH</option>
                                    <option value="Cirrhose">Cirrhose</option>
                                </select>
                            </div>
                        </div>
                </div>
            </div>
            </form>
        </div>
        </div>

        <!-- VIEW: IDENTITY & RISKS -->
        <div id="view-identity-protocols" class="view-section hidden">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-8 border-b pb-4">
                    <h3 class="text-xl font-bold text-gray-800">Dossier Patient : Profil</h3>
                    <!-- Save button removed as auto-save is active -->
                </div>

                <form id="form-identity" class="space-y-8">
                    <input type="hidden" id="patient-id">

                    <!-- SECTION 1: IDENTITY -->
                    <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-700 mb-4 flex items-center gap-2">
                            <i class="fas fa-user-circle text-blue-500"></i> Informations Administratives
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Nom</label>
                                <input type="text" id="inp-lastname"
                                    class="w-full bg-white border-gray-200 rounded-lg p-2.5 border">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Prénom</label>
                                <input type="text" id="inp-firstname"
                                    class="w-full bg-white border-gray-200 rounded-lg p-2.5 border">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Date de
                                    Naissance</label>
                                <input type="date" id="inp-birthdate"
                                    class="w-full bg-white border-gray-200 rounded-lg p-2.5 border">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Sexe</label>
                                <select id="inp-gender" class="w-full bg-white border-gray-200 rounded-lg p-2.5 border">
                                    <option value="">Sélectionner...</option>
                                    <option value="M">Homme</option>
                                    <option value="F">Femme</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Médecin Traitant</label>
                                <input type="text" id="inp-gp"
                                    class="w-full bg-white border-gray-200 rounded-lg p-2.5 border">
                            </div>
                            <!-- Age Input (Readonly) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Âge</label>
                                <input type="text" id="inp-age" readonly
                                    class="w-full bg-gray-100 border-gray-200 rounded-lg p-2.5 border text-gray-500 cursor-not-allowed font-medium text-center"
                                    placeholder="--">
                            </div>
                        </div>
                    </div>

                    <!-- Protocol Card (New) -->
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm mt-8">
                        <h4 class="text-lg font-semibold text-gray-700 mb-4 flex items-center gap-2">
                            <i class="fas fa-clipboard-list text-purple-500"></i> Protocoles & Missions
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"
                            id="protocol-grid">
                            <!-- DT2 -->
                            <label id="card-dt2"
                                class="protocol-card relative flex flex-col p-4 rounded-xl border-2 transition-all duration-200 cursor-pointer bg-gray-50 border-gray-200 hover:border-blue-300 group min-h-[140px] justify-between">
                                <input type="checkbox" id="proto-dt2" class="peer sr-only" data-protocol="dt2"
                                    data-color="yellow">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm text-gray-400 group-hover:text-yellow-600 transition-colors">
                                        <i class="fas fa-candy-cane text-xl"></i>
                                    </div>
                                    <span
                                        class="font-bold text-gray-600 group-hover:text-gray-900 transition-colors">Diabète
                                        Type 2</span>
                                </div>
                                <div class="mt-4 hidden peer-checked:block animate-fade-in-up">
                                    <div class="relative">
                                        <input type="date" id="date-dt2"
                                            class="block px-2.5 pb-1.5 pt-3 w-full text-sm text-gray-900 bg-white/50 border border-gray-300 rounded-lg appearance-none focus:outline-none focus:ring-0 focus:border-yellow-600 peer font-medium"
                                            placeholder=" " />
                                        <label for="date-dt2"
                                            class="absolute text-xs text-gray-500 duration-300 transform -translate-y-3 scale-90 top-1 z-10 origin-[0] left-2.5 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-2 peer-focus:scale-90 peer-focus:-translate-y-3 peer-focus:text-yellow-700">Inclusion</label>
                                    </div>
                                </div>
                            </label>

                            <!-- RCVA -->
                            <label id="card-rcva"
                                class="protocol-card relative flex flex-col p-4 rounded-xl border-2 transition-all duration-200 cursor-pointer bg-gray-50 border-gray-200 hover:border-blue-300 group min-h-[140px] justify-between">
                                <input type="checkbox" id="proto-rcva" class="peer sr-only" data-protocol="rcva"
                                    data-color="red">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm text-gray-400 group-hover:text-red-600 transition-colors">
                                        <i class="fas fa-heart-pulse text-xl"></i>
                                    </div>
                                    <span
                                        class="font-bold text-gray-600 group-hover:text-gray-900 transition-colors">Risque
                                        CV Absolu</span>
                                </div>
                                <div class="mt-4 hidden peer-checked:block animate-fade-in-up">
                                    <div class="relative">
                                        <input type="date" id="date-rcva"
                                            class="block px-2.5 pb-1.5 pt-3 w-full text-sm text-gray-900 bg-white/50 border border-gray-300 rounded-lg appearance-none focus:outline-none focus:ring-0 focus:border-red-600 peer font-medium"
                                            placeholder=" " />
                                        <label for="date-rcva"
                                            class="absolute text-xs text-gray-500 duration-300 transform -translate-y-3 scale-90 top-1 z-10 origin-[0] left-2.5 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-2 peer-focus:scale-90 peer-focus:-translate-y-3 peer-focus:text-red-700">Inclusion</label>
                                    </div>
                                </div>
                            </label>

                            <!-- Smoke -->
                            <label id="card-smoke"
                                class="protocol-card relative flex flex-col p-4 rounded-xl border-2 transition-all duration-200 cursor-pointer bg-gray-50 border-gray-200 hover:border-blue-300 group min-h-[140px] justify-between">
                                <input type="checkbox" id="proto-smoke" class="peer sr-only" data-protocol="smoke"
                                    data-color="blue">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm text-gray-400 group-hover:text-blue-600 transition-colors">
                                        <i class="fas fa-smoking-ban text-xl"></i>
                                    </div>
                                    <span
                                        class="font-bold text-gray-600 group-hover:text-gray-900 transition-colors">Sevrage
                                        Tabac</span>
                                </div>
                                <div class="mt-4 hidden peer-checked:block animate-fade-in-up">
                                    <div class="relative">
                                        <input type="date" id="date-smoke"
                                            class="block px-2.5 pb-1.5 pt-3 w-full text-sm text-gray-900 bg-white/50 border border-gray-300 rounded-lg appearance-none focus:outline-none focus:ring-0 focus:border-blue-600 peer font-medium"
                                            placeholder=" " />
                                        <label for="date-smoke"
                                            class="absolute text-xs text-gray-500 duration-300 transform -translate-y-3 scale-90 top-1 z-10 origin-[0] left-2.5 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-2 peer-focus:scale-90 peer-focus:-translate-y-3 peer-focus:text-blue-700">Inclusion</label>
                                    </div>
                                </div>
                            </label>

                            <!-- Asthme -->
                            <label id="card-asthme"
                                class="protocol-card relative flex flex-col p-4 rounded-xl border-2 transition-all duration-200 cursor-pointer bg-gray-50 border-gray-200 hover:border-blue-300 group min-h-[140px] justify-between">
                                <input type="checkbox" id="proto-asthme" class="peer sr-only" data-protocol="asthme"
                                    data-color="blue">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm text-gray-400 group-hover:text-blue-600 transition-colors">
                                        <i class="fas fa-lungs text-xl"></i>
                                    </div>
                                    <span
                                        class="font-bold text-gray-600 group-hover:text-gray-900 transition-colors">Asthme</span>
                                </div>
                                <div class="mt-4 hidden peer-checked:block animate-fade-in-up">
                                    <div class="relative">
                                        <input type="date" id="date-asthme"
                                            class="block px-2.5 pb-1.5 pt-3 w-full text-sm text-gray-900 bg-white/50 border border-gray-300 rounded-lg appearance-none focus:outline-none focus:ring-0 focus:border-blue-600 peer font-medium"
                                            placeholder=" " />
                                        <label for="date-asthme"
                                            class="absolute text-xs text-gray-500 duration-300 transform -translate-y-3 scale-90 top-1 z-10 origin-[0] left-2.5 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-2 peer-focus:scale-90 peer-focus:-translate-y-3 peer-focus:text-blue-700">Inclusion</label>
                                    </div>
                                </div>
                            </label>

                            <!-- BPCO -->
                            <label id="card-bpco"
                                class="protocol-card relative flex flex-col p-4 rounded-xl border-2 transition-all duration-200 cursor-pointer bg-gray-50 border-gray-200 hover:border-blue-300 group min-h-[140px] justify-between">
                                <input type="checkbox" id="proto-bpco" class="peer sr-only" data-protocol="bpco"
                                    data-color="blue">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm text-gray-400 group-hover:text-blue-600 transition-colors">
                                        <i class="fas fa-lungs-virus text-xl"></i>
                                    </div>
                                    <span
                                        class="font-bold text-gray-600 group-hover:text-gray-900 transition-colors">BPCO</span>
                                </div>
                                <div class="mt-4 hidden peer-checked:block animate-fade-in-up">
                                    <div class="relative">
                                        <input type="date" id="date-bpco"
                                            class="block px-2.5 pb-1.5 pt-3 w-full text-sm text-gray-900 bg-white/50 border border-gray-300 rounded-lg appearance-none focus:outline-none focus:ring-0 focus:border-blue-600 peer font-medium"
                                            placeholder=" " />
                                        <label for="date-bpco"
                                            class="absolute text-xs text-gray-500 duration-300 transform -translate-y-3 scale-90 top-1 z-10 origin-[0] left-2.5 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-2 peer-focus:scale-90 peer-focus:-translate-y-3 peer-focus:text-blue-700">Inclusion</label>
                                    </div>
                                </div>
                            </label>

                            <!-- Cognitive -->
                            <label id="card-cog"
                                class="protocol-card relative flex flex-col p-4 rounded-xl border-2 transition-all duration-200 cursor-pointer bg-gray-50 border-gray-200 hover:border-blue-300 group min-h-[140px] justify-between">
                                <input type="checkbox" id="proto-cog" class="peer sr-only" data-protocol="cog"
                                    data-color="green">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm text-gray-400 group-hover:text-green-600 transition-colors">
                                        <i class="fas fa-brain text-xl"></i>
                                    </div>
                                    <span
                                        class="font-bold text-gray-600 group-hover:text-gray-900 transition-colors">Troubles
                                        Cognitifs</span>
                                </div>
                                <div class="mt-4 hidden peer-checked:block animate-fade-in-up">
                                    <div class="relative">
                                        <input type="date" id="date-cog"
                                            class="block px-2.5 pb-1.5 pt-3 w-full text-sm text-gray-900 bg-white/50 border border-gray-300 rounded-lg appearance-none focus:outline-none focus:ring-0 focus:border-green-600 peer font-medium"
                                            placeholder=" " />
                                        <label for="date-cog"
                                            class="absolute text-xs text-gray-500 duration-300 transform -translate-y-3 scale-90 top-1 z-10 origin-[0] left-2.5 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-2 peer-focus:scale-90 peer-focus:-translate-y-3 peer-focus:text-green-700">Inclusion</label>
                                    </div>
                                </div>
                            </label>

                            <!-- Prevention -->
                            <label id="card-prev"
                                class="protocol-card relative flex flex-col p-4 rounded-xl border-2 transition-all duration-200 cursor-pointer bg-gray-50 border-gray-200 hover:border-blue-300 group min-h-[140px] justify-between">
                                <input type="checkbox" id="proto-prev" class="peer sr-only" data-protocol="prev"
                                    data-color="purple">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm text-gray-400 group-hover:text-purple-600 transition-colors">
                                        <i class="fas fa-shield-virus text-xl"></i>
                                    </div>
                                    <span
                                        class="font-bold text-gray-600 group-hover:text-gray-900 transition-colors">Prévention
                                        Syst.</span>
                                </div>
                                <div class="mt-4 hidden peer-checked:block animate-fade-in-up">
                                    <div class="relative">
                                        <input type="date" id="date-prev"
                                            class="block px-2.5 pb-1.5 pt-3 w-full text-sm text-gray-900 bg-white/50 border border-gray-300 rounded-lg appearance-none focus:outline-none focus:ring-0 focus:border-purple-600 peer font-medium"
                                            placeholder=" " />
                                        <label for="date-prev"
                                            class="absolute text-xs text-gray-500 duration-300 transform -translate-y-3 scale-90 top-1 z-10 origin-[0] left-2.5 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-2 peer-focus:scale-90 peer-focus:-translate-y-3 peer-focus:text-purple-700">Inclusion</label>
                                    </div>
                                </div>
                            </label>
                        </div>
                </form>
            </div>
        </div>
        </div> <!-- Added missing closing tag for view-identity-protocols -->

        <div id="view-followup" class="view-section hidden">
            <div class="max-w-7xl mx-auto space-y-6">
                <!-- Quick Dial Module -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-4">
                            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                <i class="fas fa-flask text-blue-500"></i> Saisie Rapide
                            </h3>
                            <div class="h-6 w-px bg-gray-200"></div>
                            <input type="date" id="bio-date"
                                class="header-date-input bg-transparent border-none text-gray-600 font-medium focus:ring-0 cursor-pointer"
                                title="Saisissez la date du bilan">
                        </div>
                        <div class="flex gap-2">
                            <button id="btn-add-bio"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                                <i class="fas fa-plus"></i> Ajouter
                            </button>
                            <button id="btn-clear-bio"
                                class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-eraser"></i> Effacer
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6">

                        <!-- Anthropométrie -->
                        <div class="lg:col-span-2">
                            <div class="input-group-title">Anthropométrie</div>
                            <div class="input-group-container">
                                <div class="input-wrapper">
                                    <input type="number" id="bio-weight" class="floating-input" placeholder=" "
                                        step="0.1">
                                    <label class="floating-label">Poids (kg)</label>
                                </div>
                                <div class="input-wrapper">
                                    <input type="number" id="bio-height" class="floating-input" placeholder=" "
                                        step="1">
                                    <label class="floating-label">Taille (cm)</label>
                                </div>
                                <div class="input-wrapper is-calculated bg-gray-50">
                                    <input type="text" id="bio-bmi" class="floating-input" placeholder=" " readonly>
                                    <label class="floating-label">IMC</label>
                                </div>
                            </div>
                        </div>

                        <!-- Glycémie -->
                        <div class="lg:col-span-1">
                            <div class="input-group-title">Glycémie</div>
                            <div class="input-group-container">
                                <div class="input-wrapper">
                                    <input type="number" id="bio-hba1c" class="floating-input" placeholder=" "
                                        step="0.1">
                                    <label class="floating-label">HbA1c (%)</label>
                                </div>
                            </div>
                        </div>

                        <!-- Lipides -->
                        <div class="lg:col-span-3">
                            <div class="input-group-title grid grid-cols-3 items-center w-full"
                                style="justify-items: center;">
                                <span></span> <!-- Spacer to balance grid -->
                                <span>Lipides</span>
                                <button type="button" id="toggle-unit-lipid"
                                    class="unit-toggle text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-1 rounded transition-colors"
                                    data-unit="g/L">Convertir en mmol/L</button>
                            </div>
                            <div class="input-group-container">
                                <div class="input-wrapper">
                                    <input type="number" id="bio-ct" class="floating-input" placeholder=" " step="0.01">
                                    <label class="floating-label">CT (g/L)</label>
                                </div>
                                <div class="input-wrapper">
                                    <input type="number" id="bio-hdl" class="floating-input" placeholder=" "
                                        step="0.01">
                                    <label class="floating-label">HDL (g/L)</label>
                                </div>
                                <div class="input-wrapper">
                                    <input type="number" id="bio-tg" class="floating-input" placeholder=" " step="0.01">
                                    <label class="floating-label">TG (g/L)</label>
                                </div>
                                <div class="input-wrapper is-calculated bg-gray-50">
                                    <input type="text" id="bio-nonhdl" class="floating-input" placeholder=" " readonly>
                                    <label class="floating-label">Non-HDLc (g/L)</label>
                                </div>
                                <div class="input-wrapper is-calculated bg-gray-50">
                                    <input type="text" id="bio-ldl" class="floating-input" placeholder=" " readonly>
                                    <label class="floating-label">LDLc (g/L)</label>
                                </div>
                            </div>
                        </div>

                        <!-- Fonction Rénale -->
                        <!-- Fonction Rénale -->
                        <div class="lg:col-span-3">
                            <div class="input-group-title grid grid-cols-3 items-center w-full"
                                style="justify-items: center;">
                                <button type="button" id="toggle-unit-creat"
                                    class="unit-toggle text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-1 rounded transition-colors"
                                    data-unit="µmol/L">Convertir en mg/L</button>
                                <span>Fonction Rénale</span>
                                <button type="button" id="toggle-unit-rac"
                                    class="unit-toggle text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-1 rounded transition-colors"
                                    data-unit="mg/mmol">Convertir en mg/g</button>
                            </div>
                            <div class="input-group-container">
                                <div class="input-wrapper">
                                    <input type="number" id="bio-creat" class="floating-input" placeholder=" " step="1">
                                    <label class="floating-label">Créatinine (µmol/L)</label>
                                </div>
                                <div class="input-wrapper is-calculated bg-gray-50">
                                    <input type="text" id="bio-dfg" class="floating-input" placeholder=" " readonly>
                                    <label class="floating-label">DFG (CKD-EPI)</label>
                                </div>
                                <div class="input-wrapper">
                                    <input type="number" id="bio-rac" class="floating-input" placeholder=" " step="0.1">
                                    <label class="floating-label">RAC (mg/mmol)</label>
                                </div>
                            </div>
                        </div>

                        <!-- Pression Artérielle -->
                        <div class="lg:col-span-2">
                            <div class="input-group-title">Pression Artérielle</div>
                            <div class="input-group-container">
                                <div class="input-wrapper">
                                    <input type="number" id="bio-sys" class="floating-input" placeholder=" " step="1">
                                    <label class="floating-label">PAS (mmHg)</label>
                                </div>
                                <div class="input-wrapper">
                                    <input type="number" id="bio-dia" class="floating-input" placeholder=" " step="1">
                                    <label class="floating-label">PAD (mmHg)</label>
                                </div>
                            </div>
                        </div>

                        <!-- Risque -->
                        <div class="lg:col-span-1">
                            <div class="input-group-title">Risque CV</div>
                            <div class="input-group-container flex gap-2">
                                <div class="input-wrapper is-calculated bg-gray-50 flex-1">
                                    <input type="text" id="bio-score2d" class="floating-input" placeholder=" " readonly>
                                    <label class="floating-label">SCORE2 (%)</label>
                                </div>
                                <button type="button" id="score2d-status-btn"
                                    class="w-10 bg-white rounded-lg flex items-center justify-center hover:bg-gray-50 transition-colors border border-gray-200"
                                    title="Statut du calcul">
                                    <i id="score2d-status-icon" class="fas fa-question text-gray-300 text-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Table -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-history text-blue-500"></i> Historique
                    </h3>
                    <div class="history-table-container">
                        <table class="w-full history-table" id="bio-history-table">
                            <thead>
                                <tr>
                                    <th title="Date de l'analyse">Date</th>
                                    <th title="Poids en kg">Poids</th>
                                    <th title="Indice de Masse Corporelle (kg/m²)">IMC</th>
                                    <th title="Pression Artérielle Systolique (mmHg)">PAS</th>
                                    <th title="Pression Artérielle Diastolique (mmHg)">PAD</th>
                                    <th title="Créatinine (µmol/L)">Créat</th>
                                    <th title="Débit de Filtration Glomérulaire (ml/min/1.73m²)">DFG</th>
                                    <th title="Ratio Albumine/Créatinine (mg/mmol)">RAC</th>
                                    <th title="Cholestérol Total (g/L)">CT</th>
                                    <th title="Triglycérides (g/L)">TG</th>
                                    <th title="LDL Cholestérol (g/L)">LDLc</th>
                                    <th title="Hémoglobine Glyquée (%)">HbA1c</th>
                                    <th title="Risque SCORE2-Diabetes (%)">SCORE</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Rows will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Evolution Graph -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <i class="fas fa-chart-line text-blue-500"></i> Évolution
                        </h3>
                        <div class="flex gap-2">
                            <div class="flex bg-gray-100 rounded-lg p-1 mr-2 gap-1">
                                <button
                                    class="px-3 py-1 text-xs font-semibold rounded-md text-gray-500 hover:bg-white hover:text-blue-600 hover:shadow-sm transition-all chart-time-filter"
                                    data-range="all">Tout</button>
                                <button
                                    class="px-3 py-1 text-xs font-semibold rounded-md text-gray-500 hover:bg-white hover:text-blue-600 hover:shadow-sm transition-all chart-time-filter active"
                                    data-range="1y">1 an</button>
                            </div>
                            <select id="chart-metric-select"
                                class="bg-gray-50 border-gray-200 rounded-lg text-sm py-1 px-3 focus:ring-2 focus:ring-blue-200">
                                <option value="weight">Poids</option>
                                <option value="bp">Pression Artérielle</option>
                                <option value="hba1c">HbA1c</option>
                                <option value="dfg">Fonction Rénale (DFG)</option>
                                <option value="rac">Ratio Albumine/Créatinine (RAC)</option>
                                <option value="lipids">Lipides</option>
                            </select>
                        </div>
                    </div>
                    <div class="relative h-80 w-full">
                        <canvas id="evolutionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- SCORE2-Diabetes Info Modal -->
            <div id="score2d-modal" class="modal hidden">
                <div class="modal-content">
                    <span class="close-button" id="close-score2d-modal">&times;</span>
                    <h2 class="text-xl font-bold mb-4 text-gray-800">Détails SCORE2-Diabetes</h2>
                    <div id="score2d-modal-body" class="text-sm text-gray-600 space-y-2">
                        <!-- Content populated by JS -->
                    </div>
                </div>
            </div>
        </div>
        <!-- VIEW: EXAMS -->
        <div id="view-exams" class="view-section hidden">
            <div class="max-w-7xl mx-auto space-y-8">

                <!-- Systematic Exams Section -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center gap-2">
                        Examens de Suivi Systématique
                    </h3>

                    <!-- Header Row -->
                    <div
                        class="grid grid-cols-12 gap-4 bg-gray-50 p-3 rounded-t-lg text-xs font-bold text-gray-500 uppercase tracking-wider">
                        <div class="col-span-3">Examen</div>
                        <div class="col-span-4 text-center">Dernière Réal.</div>
                        <div class="col-span-4 text-center">Renouv.</div>
                        <div class="col-span-1 text-center">Statut</div>
                    </div>

                    <!-- Rows Wrapper -->
                    <div class="divide-y divide-gray-100" id="systematic-exams-list">
                        <!-- Template Row (Will be repeated 7 times manually for specific IDs) -->

                        <!-- 1. HbA1c -->
                        <div class="grid grid-cols-12 gap-4 p-4 items-center hover:bg-gray-50 transition-colors">
                            <div class="col-span-3 flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-full bg-pink-100 flex items-center justify-center text-pink-500 flex-shrink-0">
                                    <i class="fas fa-tint"></i>
                                </div>
                                <span class="font-medium text-gray-700">HbA1c</span>
                                <i class="fas fa-info-circle text-blue-400 text-xs cursor-help"
                                    title="Hémoglobine Glyquée - Trimestriel"></i>
                            </div>
                            <div class="col-span-4 flex gap-2 justify-center" id="container-hba1c-last">
                                <select
                                    class="exam-month-select w-20 bg-white border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="hba1c" data-type="last" data-part="month"></select>
                                <select
                                    class="exam-year-select w-24 bg-white border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="hba1c" data-type="last" data-part="year"></select>
                            </div>
                            <div class="col-span-4 flex gap-2 justify-center" id="container-hba1c-next">
                                <select
                                    class="exam-month-select w-20 bg-gray-100 border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="hba1c" data-type="next" data-part="month"></select>
                                <select
                                    class="exam-year-select w-24 bg-gray-100 border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="hba1c" data-type="next" data-part="year"></select>
                            </div>
                            <div class="col-span-1 text-center justify-center items-center flex" id="status-hba1c">
                                <span class="text-gray-300">--</span>
                            </div>
                        </div>

                        <!-- 2. Bilan Lipidique -->
                        <div class="grid grid-cols-12 gap-4 p-4 items-center hover:bg-gray-50 transition-colors">
                            <div class="col-span-3 flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-500 flex-shrink-0">
                                    <i class="fas fa-vial"></i>
                                </div>
                                <span class="font-medium text-gray-700">Bilan Lipidique</span>
                                <i class="fas fa-info-circle text-blue-400 text-xs cursor-help"
                                    title="Cholestérol, Triglycérides - Annuel"></i>
                            </div>
                            <div class="col-span-4 flex gap-2 justify-center">
                                <select
                                    class="exam-month-select w-20 bg-white border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="lipids" data-type="last" data-part="month"></select>
                                <select
                                    class="exam-year-select w-24 bg-white border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="lipids" data-type="last" data-part="year"></select>
                            </div>
                            <div class="col-span-4 flex gap-2 justify-center">
                                <select
                                    class="exam-month-select w-20 bg-gray-100 border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="lipids" data-type="next" data-part="month"></select>
                                <select
                                    class="exam-year-select w-24 bg-gray-100 border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="lipids" data-type="next" data-part="year"></select>
                            </div>
                            <div class="col-span-1 text-center justify-center items-center flex" id="status-lipids">
                                <span class="text-gray-300">--</span>
                            </div>
                        </div>

                        <!-- 3. RAC -->
                        <div class="grid grid-cols-12 gap-4 p-4 items-center hover:bg-gray-50 transition-colors">
                            <div class="col-span-3 flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-500 flex-shrink-0">
                                    <i class="fas fa-tint"></i> <!-- Drop icon -->
                                </div>
                                <span class="font-medium text-gray-700">RAC</span>
                                <i class="fas fa-info-circle text-blue-400 text-xs cursor-help"
                                    title="Ratio Albumine/Créatinine - Annuel"></i>
                            </div>
                            <div class="col-span-4 flex gap-2 justify-center">
                                <select
                                    class="exam-month-select w-20 bg-white border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="rac" data-type="last" data-part="month"></select>
                                <select
                                    class="exam-year-select w-24 bg-white border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="rac" data-type="last" data-part="year"></select>
                            </div>
                            <div class="col-span-4 flex gap-2 justify-center">
                                <select
                                    class="exam-month-select w-20 bg-gray-100 border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="rac" data-type="next" data-part="month"></select>
                                <select
                                    class="exam-year-select w-24 bg-gray-100 border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="rac" data-type="next" data-part="year"></select>
                            </div>
                            <div class="col-span-1 text-center justify-center items-center flex" id="status-rac">
                                <span class="text-gray-300">--</span>
                            </div>
                        </div>

                        <!-- 4. ECG -->
                        <div class="grid grid-cols-12 gap-4 p-4 items-center hover:bg-gray-50 transition-colors">
                            <div class="col-span-3 flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-500 flex-shrink-0">
                                    <i class="fas fa-heartbeat"></i>
                                </div>
                                <span class="font-medium text-gray-700">ECG</span>
                                <i class="fas fa-info-circle text-blue-400 text-xs cursor-help"
                                    title="ECG de repos - Annuel ou tous les 3 ans selon risque"></i>
                            </div>
                            <div class="col-span-4 flex gap-2 justify-center">
                                <select
                                    class="exam-month-select w-20 bg-white border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="ecg" data-type="last" data-part="month"></select>
                                <select
                                    class="exam-year-select w-24 bg-white border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="ecg" data-type="last" data-part="year"></select>
                            </div>
                            <div class="col-span-4 flex gap-2 justify-center">
                                <select
                                    class="exam-month-select w-20 bg-gray-100 border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="ecg" data-type="next" data-part="month"></select>
                                <select
                                    class="exam-year-select w-24 bg-gray-100 border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="ecg" data-type="next" data-part="year"></select>
                            </div>
                            <div class="col-span-1 text-center justify-center items-center flex" id="status-ecg">
                                <span class="text-gray-300">--</span>
                            </div>
                        </div>

                        <!-- 5. Pieds -->
                        <div class="grid grid-cols-12 gap-4 p-4 items-center hover:bg-gray-50 transition-colors">
                            <div class="col-span-3 flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600 flex-shrink-0">
                                    <i class="fas fa-shoe-prints"></i>
                                </div>
                                <span class="font-medium text-gray-700">Examen des Pieds</span>
                                <i class="fas fa-info-circle text-blue-400 text-xs cursor-help"
                                    title="Test au monofilament / Podologue - Annuel"></i>
                            </div>
                            <div class="col-span-4 flex gap-2 justify-center">
                                <select
                                    class="exam-month-select w-20 bg-white border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="feet" data-type="last" data-part="month"></select>
                                <select
                                    class="exam-year-select w-24 bg-white border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="feet" data-type="last" data-part="year"></select>
                            </div>
                            <div class="col-span-4 flex gap-2 justify-center">
                                <select
                                    class="exam-month-select w-20 bg-gray-100 border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="feet" data-type="next" data-part="month"></select>
                                <select
                                    class="exam-year-select w-24 bg-gray-100 border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="feet" data-type="next" data-part="year"></select>
                            </div>
                            <div class="col-span-1 text-center justify-center items-center flex" id="status-feet">
                                <span class="text-gray-300">--</span>
                            </div>
                        </div>

                        <!-- 6. Dentiste -->
                        <div class="grid grid-cols-12 gap-4 p-4 items-center hover:bg-gray-50 transition-colors">
                            <div class="col-span-3 flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 flex-shrink-0">
                                    <i class="fas fa-tooth"></i>
                                </div>
                                <span class="font-medium text-gray-700">Dentiste</span>
                                <i class="fas fa-info-circle text-blue-400 text-xs cursor-help"
                                    title="Bilan bucco-dentaire - Annuel"></i>
                            </div>
                            <div class="col-span-4 flex gap-2 justify-center">
                                <select
                                    class="exam-month-select w-20 bg-white border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="dental" data-type="last" data-part="month"></select>
                                <select
                                    class="exam-year-select w-24 bg-white border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="dental" data-type="last" data-part="year"></select>
                            </div>
                            <div class="col-span-4 flex gap-2 justify-center">
                                <select
                                    class="exam-month-select w-20 bg-gray-100 border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="dental" data-type="next" data-part="month"></select>
                                <select
                                    class="exam-year-select w-24 bg-gray-100 border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="dental" data-type="next" data-part="year"></select>
                            </div>
                            <div class="col-span-1 text-center justify-center items-center flex" id="status-dental">
                                <span class="text-gray-300">--</span>
                            </div>
                        </div>

                        <!-- 7. Ophtalmo -->
                        <div class="grid grid-cols-12 gap-4 p-4 items-center hover:bg-gray-50 transition-colors">
                            <div class="col-span-3 flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 flex-shrink-0">
                                    <i class="fas fa-eye"></i>
                                </div>
                                <span class="font-medium text-gray-700">Ophtalmo</span>
                                <i class="fas fa-info-circle text-blue-400 text-xs cursor-help"
                                    title="Fond d'œil / Rétinographie - Bisannuel si pas de rétinopathie"></i>
                            </div>
                            <div class="col-span-4 flex gap-2 justify-center">
                                <select
                                    class="exam-month-select w-20 bg-white border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="eyes" data-type="last" data-part="month"></select>
                                <select
                                    class="exam-year-select w-24 bg-white border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="eyes" data-type="last" data-part="year"></select>
                            </div>
                            <div class="col-span-4 flex gap-2 justify-center">
                                <select
                                    class="exam-month-select w-20 bg-gray-100 border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="eyes" data-type="next" data-part="month"></select>
                                <select
                                    class="exam-year-select w-24 bg-gray-100 border border-gray-200 rounded-md text-sm py-1 px-2"
                                    data-exam="eyes" data-type="next" data-part="year"></select>
                            </div>
                            <div class="col-span-1 text-center justify-center items-center flex" id="status-eyes">
                                <span class="text-gray-300">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other Exams Section -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-gray-800">Autres Examens et Consultations</h3>
                        <button id="btn-add-other-exam"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            Ajouter
                        </button>
                    </div>

                    <!-- Add Form -->
                    <div id="add-other-exam-form"
                        class="hidden bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6 animate-fade-in">
                        <div class="grid grid-cols-12 gap-4 items-end">
                            <div class="col-span-3">
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Type d'examen /
                                    consultation</label>
                                <select id="other-exam-type"
                                    class="w-full bg-white border border-gray-200 rounded-lg text-sm p-2">
                                    <option value="">Sélectionner...</option>
                                    <option value="Consultation Cardiologue">Consultation Cardiologue</option>
                                    <option value="Consultation Endocrinologue">Consultation Endocrinologue</option>
                                    <option value="Consultation Neurologue">Consultation Neurologue</option>
                                    <option value="Consultation Néphrologue">Consultation Néphrologue</option>
                                    <option value="Consultation Pneumologue">Consultation Pneumologue</option>
                                    <option value="Consultation Podologue">Consultation Podologue</option>
                                    <option value="Épreuve d'effort (ECG)">Épreuve d'effort (ECG)</option>
                                    <option value="Échographie d'effort">Échographie d'effort</option>
                                    <option value="Scintigraphie d'efforts">Scintigraphie d'efforts</option>
                                    <option value="Coroscanner">Coroscanner</option>
                                    <option value="Score Calcique">Score Calcique</option>
                                    <option value="Coronarographie">Coronarographie</option>
                                    <option value="Échographie Cardiaque">Échographie Cardiaque</option>
                                    <option value="Holter ECG">Holter ECG</option>
                                    <option value="Échos Doppler Tronc Supra-Aortique">Échos Doppler Tronc
                                        Supra-Aortique</option>
                                    <option value="Échos Doppler Membres Inférieurs">Échos Doppler Membres Inférieurs
                                    </option>
                                    <option value="Mesure de l'IPS">Mesure de l'IPS</option>
                                </select>
                            </div>
                            <div class="col-span-3">
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Date de
                                    réalisation</label>
                                <div class="flex gap-2">
                                    <select id="other-exam-month"
                                        class="w-20 bg-white border border-gray-200 rounded-lg text-sm p-2"></select>
                                    <select id="other-exam-year"
                                        class="w-24 bg-white border border-gray-200 rounded-lg text-sm p-2"></select>
                                </div>
                            </div>
                            <div class="col-span-4">
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Résultats en très
                                    bref</label>
                                <input type="text" id="other-exam-result"
                                    class="w-full bg-white border border-gray-200 rounded-lg text-sm p-2"
                                    placeholder="Résultats...">
                            </div>
                            <div class="col-span-2 flex gap-2">
                                <button id="btn-confirm-add-exam"
                                    class="flex-1 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm p-2 transition-colors"
                                    title="Valider">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button id="btn-cancel-add-exam"
                                    class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg text-sm p-2 transition-colors"
                                    title="Annuler">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-100 text-xs uppercase font-semibold text-gray-500">
                                <tr>
                                    <th class="px-4 py-3 rounded-l-lg">Examen / Consultation</th>
                                    <th class="px-4 py-3 text-center">Date Réalisation</th>
                                    <th class="px-4 py-3 text-left">Résultats</th>
                                    <th class="px-4 py-3 text-right rounded-r-lg">Action</th>
                                </tr>
                            </thead>
                            <tbody id="other-exams-table" class="divide-y divide-gray-100">
                                <!-- Populated by JS -->
                                <tr>
                                    <td colspan="4" class="px-4 py-8 text-center text-gray-400 italic">
                                        Aucun examen manuel enregistré.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: TREATMENTS -->
        <div id="view-treatments" class="view-section hidden">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 max-w-7xl mx-auto space-y-6">
                <h3 class="text-xl font-bold text-gray-800">Traitements</h3>

                <div class="mb-8">

                    <!-- Search Section -->
                    <div class="relative z-50">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Rechercher un traitement (DCI ou
                            Nom Commercial)</label>
                        <div class="flex gap-2">
                            <div class="relative flex-grow">
                                <input type="text" id="treatment-search"
                                    class="w-full bg-white border border-blue-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition-all text-gray-800 placeholder-gray-400"
                                    placeholder="Ex: Metformine, Ozempic..." autocomplete="off">

                                <!-- Autocomplete Dropdown -->
                                <div id="treatment-suggestions"
                                    class="hidden absolute top-full left-0 w-full bg-white border border-gray-200 rounded-lg shadow-xl mt-1 max-h-64 overflow-y-auto divide-y divide-gray-100">
                                </div>
                            </div>

                            <button id="btn-copy-prescription"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium shadow-sm transition-colors flex items-center gap-2 flex-shrink-0">
                                <i class="fas fa-copy"></i> Copier
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Active Prescriptions -->
                <div>
                    <h4 class="font-bold text-gray-800 mb-4 border-b border-gray-100 pb-2">Prescriptions Actives</h4>
                    <div class="overflow-x-visible border border-gray-200 rounded-lg bg-white min-h-[200px]">
                        <table class="w-full text-left text-sm table-fixed">
                            <thead class="bg-gray-50 text-gray-600 font-semibold uppercase text-xs">
                                <tr>
                                    <th class="px-4 py-3 w-[35%]">Molécule (DCI / Commercial)</th>
                                    <th class="px-4 py-3 w-[20%]">Posologie</th>
                                    <th class="px-4 py-3 w-[15%]">Unité</th>
                                    <th class="px-4 py-3 w-[15%]">Schéma</th>
                                    <th class="px-4 py-3 w-[15%] text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="treatments-table-body" class="divide-y divide-gray-100">
                                <!-- Populated by JS -->
                                <tr>
                                    <td colspan="5" class="px-4 py-8 text-center text-gray-400 italic">
                                        Aucune prescription active.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- NEW: Intolérance et Allergies -->
                <div class="mt-8 pt-6 border-t border-gray-100">
                    <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-shield-alt text-blue-500"></i> Intolérances et Allergies
                    </h4>

                    <!-- Discreet Search -->
                    <div class="relative w-full max-w-md mb-6">
                        <div class="relative">
                            <i
                                class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs"></i>
                            <input type="text" id="allergy-search"
                                class="w-full bg-gray-50 border border-gray-200 rounded-lg py-2 pl-9 pr-4 text-sm focus:bg-white focus:ring-2 focus:ring-blue-100 focus:border-blue-400 transition-all placeholder-gray-400"
                                placeholder="Rechercher une molécule..." autocomplete="off">
                        </div>

                        <!-- Suggestions Dropdown -->
                        <div id="allergy-suggestions"
                            class="hidden absolute top-full left-0 w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-48 overflow-y-auto divide-y divide-gray-50 z-20">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Lists Container -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                        <!-- Allergies Column -->
                        <div class="bg-red-50 rounded-lg p-4 border border-red-100">
                            <h5 class="font-bold text-red-800 text-sm mb-3 flex items-center justify-between">
                                <span><i class="fas fa-exclamation-circle mr-2"></i> Allergies</span>
                                <span
                                    class="bg-white px-2 py-0.5 rounded text-xs text-red-600 border border-red-200 shadow-sm"
                                    id="count-allergies">0</span>
                            </h5>
                            <div id="list-allergies" class="space-y-2 min-h-[100px]">
                                <!-- Validated Allergies List -->
                                <div class="text-xs text-red-400 italic text-center py-4">Aucune allergie signalée</div>
                            </div>
                        </div>

                        <!-- Intolerances Column -->
                        <div class="bg-orange-50 rounded-lg p-4 border border-orange-100">
                            <h5 class="font-bold text-orange-800 text-sm mb-3 flex items-center justify-between">
                                <span><i class="fas fa-file-medical-alt mr-2"></i> Intolérances</span>
                                <span
                                    class="bg-white px-2 py-0.5 rounded text-xs text-orange-600 border border-orange-200 shadow-sm"
                                    id="count-intolerances">0</span>
                            </h5>
                            <div id="list-intolerances" class="space-y-2 min-h-[100px]">
                                <!-- Validated Intolerances List -->
                                <div class="text-xs text-orange-400 italic text-center py-4">Aucune intolérance signalée
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </div>

        <div id="view-education" class="view-section hidden">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 max-w-7xl mx-auto space-y-8">
                <h3 class="text-xl font-bold text-gray-800">Synthèse Éducative & Plan d'ETP</h3>

                <div class="grid grid-cols-12 gap-8">
                    <!-- A. Diagnostic -->
                    <div class="col-span-12 md:col-span-6">
                        <h4 class="font-bold text-blue-800 mb-4 border-b border-blue-200 pb-2">A. Diagnostic Éducatif
                            Partagé</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Dimension Biomédicale (Ce
                                    que le patient sait)</label>
                                <textarea id="diag-bio"
                                    class="w-full h-20 p-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-100 resize-none education-input"
                                    data-field="bio"
                                    placeholder="Connaissances de la maladie, du traitement..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Dimension Psycho-affective
                                    (Ce que le patient ressent)</label>
                                <textarea id="diag-psycho"
                                    class="w-full h-20 p-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-100 resize-none education-input"
                                    data-field="psycho" placeholder="Croyances, émotions, vécu..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Dimension
                                    Socio-Professionnelle (Contexte de vie)</label>
                                <textarea id="diag-social"
                                    class="w-full h-20 p-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-100 resize-none education-input"
                                    data-field="social"
                                    placeholder="Situation familiale, ressources, freins..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Attentes et Besoins du
                                    Patient</label>
                                <textarea id="diag-needs"
                                    class="w-full h-20 p-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-100 resize-none education-input"
                                    data-field="needs"
                                    placeholder="Qu'est-ce que le patient souhaite apprendre ?"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- B. Competencies -->
                    <div class="col-span-12 md:col-span-6 flex flex-col">
                        <h4 class="font-bold text-blue-800 mb-4 border-b border-blue-200 pb-2">B. Compétences &
                            Objectifs</h4>
                        <div id="competencies-list" class="flex-1 flex flex-col justify-between gap-1">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- C. Plan -->
                <div>
                    <h4 class="font-bold text-blue-800 mb-4 border-b border-blue-200 pb-2">C. Plan d'Éducation
                        Personnalisé</h4>
                    <div class="overflow-x-visible border border-gray-200 rounded-lg bg-white min-h-[200px]">
                        <table class="w-full text-left text-sm table-fixed">
                            <thead class="bg-gray-50 text-gray-600 font-semibold uppercase text-xs">
                                <tr>
                                    <th class="px-4 py-3 w-[5%] text-center">Fait</th>
                                    <th class="px-4 py-3 w-[5%] text-center">Sujet</th>
                                    <th class="px-4 py-3 w-[20%]">Date</th>
                                    <th class="px-4 py-3 w-[30%]">Séance</th>
                                    <th class="px-4 py-3 w-[35%]">Observations</th>
                                    <th class="px-4 py-3 w-[5%] text-right"></th>
                                </tr>
                            </thead>
                            <tbody id="education-plan-body" class="divide-y divide-gray-100">
                                <tr>
                                    <td colspan="6" class="px-4 py-8 text-center text-gray-400 italic">Aucune séance
                                        planifiée. Cliquez sur les boutons "+" ci-dessus pour commencer.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>


        <!-- VIEW: SYNTHESIS (Spiderweb) -->
        <!-- Absolute Inset to cover parent padding completely, White BG -->
        <div id="view-synthesis" class="view-section hidden">
            <!-- Card Container (Matches Education/Identity style) -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 max-w-7xl mx-auto space-y-6">

                <!-- Page Header -->
                <h3 class="text-xl font-bold text-gray-800">Synthèse Clinique</h3>

                <!-- 1. Top Module -->
                <div id="objectives-module">
                    <div class="overflow-x-auto border border-gray-200 rounded-lg">
                        <table class="w-full text-left text-sm whitespace-nowrap">
                            <thead class="bg-gray-100 text-gray-600 font-semibold uppercase text-xs">
                                <tr>
                                    <th class="px-4 py-3 w-[20%]">Marqueur</th>
                                    <th class="px-4 py-3 w-[20%]">Cible Personnalisée</th>
                                    <th class="px-4 py-3 w-[15%] text-center">Valeur Actuelle</th>
                                    <th class="px-4 py-3 w-[15%] text-center">Valeur Antérieure</th>
                                    <th class="px-4 py-3 w-[15%] text-center">Tendance</th>
                                    <th class="px-4 py-3 w-[15%] text-center">Statut</th>
                                </tr>
                            </thead>
                            <tbody id="objectives-table-body" class="divide-y divide-gray-100 bg-white">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 2. Bottom Chart: Flexible Height (flex-1) -->
                <div class="w-full flex flex-col items-center pt-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-2 flex-none">Blob du patient</h3>

                    <!-- Chart Wrapper: Best-fit Square (max-w-600 OR max-h-available) -->
                    <!-- flex-none to respect aspect ratio, max-h-full to prevent overflow -->
                    <div class="relative w-full max-w-[600px] aspect-square max-h-full flex-none">
                        <canvas id="synthesis-chart" class="absolute inset-0"></canvas>
                    </div>

                    <div class="mt-2 text-xs text-gray-400 italic text-center max-w-lg flex-none pb-2">
                        Ce graphique projette les dernières données connues par rapport aux objectifs cibles.
                    </div>
                </div> <!-- Close Chart Container -->
                <!-- 3. Summary & Export -->
                <div class="mt-8 pt-8 border-t border-gray-100">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-file-medical-alt text-blue-600"></i> Courriers et résumés
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Controls -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Modèle</label>
                                <select id="summary-template-select"
                                    class="w-full bg-white border border-gray-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-100">
                                    <option value="" disabled selected>Chargement des modèles...</option>
                                </select>
                            </div>
                            <button id="btn-generate-summary"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 rounded-lg shadow-sm transition-colors flex items-center justify-center gap-2">
                                <i class="fas fa-magic"></i> Générer
                            </button>

                            <hr class="border-gray-100">

                            <div class="flex flex-col gap-2">
                                <button id="btn-copy-summary"
                                    class="w-full bg-white border border-gray-200 hover:bg-gray-50 text-gray-700 font-medium py-2 rounded-lg transition-colors flex items-center justify-center gap-2">
                                    <i class="fas fa-copy"></i> Copier
                                </button>
                                <button id="btn-export-pdf"
                                    class="w-full bg-white border border-gray-200 hover:bg-gray-50 text-red-600 font-medium py-2 rounded-lg transition-colors flex items-center justify-center gap-2">
                                    <i class="fas fa-file-pdf"></i> Exporter en PDF
                                </button>
                            </div>
                        </div>

                        <!-- Editor -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Aperçu et Édition</label>
                            <textarea id="summary-editor"
                                class="w-full h-96 p-4 text-sm font-mono border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-100 focus:border-blue-400 resize-none leading-relaxed"
                                spellcheck="false" placeholder="Le résumé généré apparaîtra ici..."></textarea>
                        </div>
                    </div>
                </div>

            </div> <!-- Close Card -->
        </div> <!-- Close view-synthesis -->

        <!-- VIEW: LETTERS (Courriers) -->
        <div id="view-letters" class="view-section hidden h-full flex flex-col">
            <div class="flex flex-1 gap-6 p-6 h-full overflow-hidden">
                <!-- LEFT: Templates -->
                <div
                    class="w-1/4 bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col overflow-hidden h-full">
                    <div class="p-4 border-b border-gray-100 bg-gray-50">
                        <h3 class="font-bold text-gray-700 text-sm uppercase">Modèles</h3>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-6 custom-scrollbar">
                        <!-- System Templates -->
                        <div>
                            <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Système</h4>
                            <div id="list-templates-system" class="space-y-1">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                        <!-- Perso Templates -->
                        <div>
                            <h4
                                class="text-xs font-bold text-gray-500 uppercase mb-2 flex justify-between items-center">
                                Personnels
                                <button id="btn-create-perso-template"
                                    class="text-blue-600 hover:text-blue-800 text-xs px-2 py-1 hover:bg-blue-50 rounded transition-colors"
                                    title="Créer un nouveau modèle vide">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </h4>
                            <div id="list-templates-perso" class="space-y-1">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CENTER: Editor -->
                <div
                    class="flex-1 bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col overflow-hidden h-full">
                    <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center flex-none">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <span id="editor-template-badge"
                                class="hidden px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider flex-none"></span>
                            <h3 id="editor-template-title" class="font-bold text-gray-800 truncate">Nouveau Courrier
                            </h3>
                        </div>
                        <div class="flex gap-2 flex-none">
                            <!-- Actions (Visible based on context) -->
                            <button id="btn-copy-system-template"
                                class="hidden bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-1.5 rounded text-xs font-medium transition-colors items-center gap-1">
                                <i class="fas fa-copy"></i> Copier vers Mes Modèles
                            </button>
                            <button id="btn-save-perso-template"
                                class="hidden bg-green-600 text-white hover:bg-green-700 px-3 py-1.5 rounded text-xs font-medium transition-colors items-center gap-1">
                                <i class="fas fa-save"></i> Enregistrer
                            </button>
                            <button id="btn-delete-perso-template"
                                class="hidden bg-red-50 text-red-600 hover:bg-red-100 px-3 py-1.5 rounded text-xs font-medium transition-colors items-center gap-1">
                                <i class="fas fa-trash"></i>
                            </button>
                            <div class="w-px h-6 bg-gray-300 mx-1"></div>
                            <button id="btn-print-letter"
                                class="bg-gray-100 text-gray-700 hover:bg-gray-200 px-3 py-1.5 rounded text-xs font-medium transition-colors items-center gap-1 flex">
                                <i class="fas fa-print"></i> Imprimer
                            </button>
                        </div>
                    </div>

                    <div class="flex-1 relative flex flex-col p-8 overflow-y-auto custom-scrollbar bg-white">
                        <!-- Simulated A4 or just text area -->
                        <textarea id="letter-editor-content"
                            class="flex-1 w-full h-full resize-none focus:outline-none focus:ring-0 font-serif text-gray-800 leading-relaxed text-base placeholder-gray-300"
                            placeholder="Sélectionnez un modèle ou commencez à écrire..."></textarea>
                    </div>
                </div>

                <!-- RIGHT: Macros -->
                <div
                    class="w-1/5 bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col overflow-hidden h-full">
                    <div class="p-4 border-b border-gray-100 bg-gray-50 space-y-2">
                        <h3 class="font-bold text-gray-700 text-sm uppercase">Macros</h3>
                        <div class="relative">
                            <i
                                class="fas fa-search absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs"></i>
                            <input type="text" id="macro-search-input" placeholder="Rechercher..."
                                class="w-full pl-7 pr-2 py-1 text-xs border border-gray-200 rounded focus:border-blue-400 outline-none transition-colors">
                        </div>
                        <select id="macro-category-filter-letter"
                            class="w-full bg-white border border-gray-200 rounded px-2 py-1 text-xs outline-none focus:border-blue-400 text-gray-600">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    <div id="letters-macro-list" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>
        <!-- VIEW: ETP LIBRARY (Back-office) -->
        <div id="view-etp-library" class="view-section hidden p-8">
            <div class="max-w-7xl mx-auto space-y-6">
                <!-- Header & Actions -->
                <div class="flex justify-between items-center bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Bibliothèque ETP</h2>
                        <p class="text-gray-500 text-sm">Gérez ici le référentiel des séances disponibles pour les
                            patients.</p>
                    </div>
                    <button
                        class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg flex items-center gap-2 transition-colors font-medium shadow-sm"
                        id="btn-new-etp-session">
                        <i class="fas fa-plus"></i> Nouvelle Séance
                    </button>
                </div>

                <!-- Search & Filters -->
                <div class="flex items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                    <div class="relative flex-1">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="inp-etp-search"
                            class="w-full pl-12 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-100 focus:border-blue-400 transition-all text-sm"
                            style="padding-left: 3rem;" placeholder="Rechercher par référence, titre, catégorie...">
                    </div>
                </div>

                <!-- Sessions Table -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-4 py-3 font-semibold text-gray-600 text-xs uppercase w-16 cursor-pointer hover:bg-gray-100 transition-colors"
                                    id="sort-etp-id">
                                    Réf. <i class="fas fa-sort ml-1 text-gray-400"></i>
                                </th>
                                <th class="px-4 py-3 font-semibold text-gray-600 text-xs uppercase w-48 cursor-pointer hover:bg-gray-100 transition-colors"
                                    id="sort-etp-category">
                                    Catégorie <i class="fas fa-sort ml-1 text-gray-400"></i>
                                </th>
                                <th class="px-4 py-3 font-semibold text-gray-600 text-xs uppercase cursor-pointer hover:bg-gray-100 transition-colors"
                                    id="sort-etp-title">
                                    Intitulé <i class="fas fa-sort ml-1 text-gray-400"></i>
                                </th>
                                <th class="px-4 py-3 font-semibold text-gray-600 text-xs uppercase w-24 cursor-pointer hover:bg-gray-100 transition-colors"
                                    id="sort-etp-mode">
                                    Mode <i class="fas fa-sort ml-1 text-gray-400"></i>
                                </th>
                                <th class="px-4 py-3 font-semibold text-gray-600 text-xs uppercase text-right w-24">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="table-etp-library" class="divide-y divide-gray-100">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- VIEW: PHARMA BOOK (New) -->
        <div id="view-pharma-book" class="view-section hidden p-8">
            <div class="max-w-7xl mx-auto space-y-6">
                <div class="flex justify-between items-center bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Livret Pharmaceutique</h2>
                        <p class="text-gray-500 text-sm">Gérez ici le référentiel des médicaments.</p>
                    </div>
                    <button
                        class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg flex items-center gap-2 transition-colors font-medium shadow-sm"
                        id="btn-new-medication">
                        <i class="fas fa-plus"></i> Nouveau Médicament
                    </button>
                </div>

                <div class="flex items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                    <div class="relative flex-1">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="inp-pharma-search"
                            class="w-full pl-12 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-100 focus:border-blue-400 transition-all text-sm"
                            placeholder="Rechercher...">
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <table class="w-full text-left table-fixed">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-4 py-3 font-semibold text-gray-600 text-xs uppercase w-48 cursor-pointer hover:bg-gray-100 transition-colors select-none"
                                    data-sort="dci">
                                    DCI <i class="fas fa-sort-alpha-down ml-1 text-gray-400" id="icon-sort-dci"></i>
                                </th>
                                <th class="px-4 py-3 font-semibold text-gray-600 text-xs uppercase w-48 cursor-pointer hover:bg-gray-100 transition-colors select-none"
                                    data-sort="commercial_name">
                                    Nom Commercial <i class="fas fa-sort ml-1 text-gray-300"
                                        id="icon-sort-commercial_name"></i>
                                </th>
                                <th class="px-4 py-3 font-semibold text-gray-600 text-xs uppercase w-48 cursor-pointer hover:bg-gray-100 transition-colors select-none"
                                    data-sort="class">
                                    Classe <i class="fas fa-sort ml-1 text-gray-300" id="icon-sort-class"></i>
                                </th>
                                <th class="px-4 py-3 font-semibold text-gray-600 text-xs uppercase w-32 cursor-pointer hover:bg-gray-100 transition-colors select-none"
                                    data-sort="route">
                                    Voie <i class="fas fa-sort ml-1 text-gray-300" id="icon-sort-route"></i>
                                </th>
                                <th class="px-4 py-3 font-semibold text-gray-600 text-xs uppercase">Posologies</th>
                                <th class="px-4 py-3 font-semibold text-gray-600 text-xs uppercase text-right w-24">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-pharma-book" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VIEW: TEMPLATES MANAGER (New) -->
        <div id="view-templates" class="view-section hidden p-8 h-full flex flex-col">
            <div class="max-w-7xl mx-auto w-full h-full flex flex-col gap-6">
                <!-- Header -->
                <div
                    class="flex justify-between items-center bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex-none">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Gestion des Modèles</h2>
                        <p class="text-gray-500 text-sm">Créez et modifiez vos modèles de courriers et comptes-rendus.
                        </p>
                    </div>
                    <button
                        class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg flex items-center gap-2 transition-colors font-medium shadow-sm"
                        id="btn-new-template">
                        <i class="fas fa-plus"></i> Nouveau Modèle
                    </button>
                </div>

                <div class="flex-1 flex gap-6 overflow-hidden">
                    <!-- Left: List -->
                    <div
                        class="w-1/4 bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col overflow-hidden">
                        <div class="p-4 border-b border-gray-100 bg-gray-50">
                            <h3 class="font-bold text-gray-700 text-sm uppercase">Vos Modèles</h3>
                        </div>
                        <div class="flex-1 overflow-y-auto p-2 space-y-2" id="template-list-container">
                            <!-- Populated by JS -->
                            <div class="text-center text-gray-400 text-sm py-8">Chargement...</div>
                        </div>
                    </div>

                    <!-- Center: Editor -->
                    <div class="flex-1 bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col overflow-hidden hidden"
                        id="template-editor-panel">
                        <div class="p-4 border-b border-gray-100 flex gap-4 items-center bg-gray-50">
                            <input type="text" id="inp-tpl-name"
                                class="flex-1 bg-white border border-gray-200 rounded px-3 py-1.5 focus:ring-2 focus:ring-blue-100 outline-none font-semibold text-gray-800"
                                placeholder="Nom du modèle">
                            <select id="inp-tpl-category"
                                class="bg-white border border-gray-200 rounded px-3 py-1.5 text-sm focus:ring-2 focus:ring-blue-100 outline-none text-gray-600">
                                <option value="courrier">Courrier</option>
                                <option value="synthese">Synthèse</option>
                                <option value="autre">Autre</option>
                            </select>
                            <div class="flex gap-2">
                                <button id="btn-save-template"
                                    class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm transition-colors flex items-center gap-2"
                                    title="Enregistrer">
                                    <i class="fas fa-save"></i>
                                </button>
                                <button id="btn-edit-template"
                                    class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1.5 rounded text-sm transition-colors flex items-center gap-2"
                                    title="Modifier / Débloquer">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button id="btn-delete-template"
                                    class="bg-red-50 hover:bg-red-100 text-red-600 px-3 py-1.5 rounded text-sm transition-colors flex items-center gap-2"
                                    title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex-1 p-4 flex flex-col">
                            <textarea id="inp-tpl-content"
                                class="flex-1 w-full p-4 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-100 focus:border-blue-400 resize-none font-mono text-sm leading-relaxed"
                                placeholder="Contenu du modèle... Utilisez les macros à droite."></textarea>
                        </div>
                        <div class="p-2 bg-gray-50 border-t border-gray-100 text-xs text-gray-500 text-center">
                            Modifications non enregistrées
                        </div>
                    </div>
                    <!-- Empty State for Editor -->
                    <div class="flex-1 bg-white rounded-xl shadow-sm border border-gray-100 flex items-center justify-center text-gray-400 flex-col gap-2"
                        id="template-editor-empty">
                        <i class="fas fa-file-signature text-4xl mb-2 text-gray-200"></i>
                        <p>Sélectionnez un modèle pour l'éditer</p>
                    </div>

                    <!-- Right: Macros -->
                    <div
                        class="w-1/4 bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col overflow-hidden">
                        <div class="p-4 border-b border-gray-100 bg-gray-50 flex flex-col gap-2">
                            <h3 class="font-bold text-gray-700 text-sm uppercase">Macros Disponibles</h3>
                            <select id="macro-category-filter"
                                class="w-full bg-white border border-gray-200 rounded px-2 py-1 text-xs outline-none focus:border-blue-400 text-gray-600">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4 space-y-6" id="macro-list-container">
                            <!-- Populated by JS -->

                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div> <!-- Close content-area -->

    </main>

    <!-- MODAL: ETP SESSION EDITOR -->
    <div id="modal-etp-session" class="modal hidden">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800" id="modal-etp-title">Nouvelle Séance</h3>
                <span class="close-button text-gray-400 hover:text-gray-600 cursor-pointer text-2xl"
                    id="close-modal-etp">&times;</span>
            </div>

            <form id="form-etp-session" class="space-y-4">
                <input type="hidden" id="inp-etp-id">

                <!-- Row 1: Code & Title -->
                <div class="grid grid-cols-4 gap-4">
                    <div class="col-span-1">
                        <div class="input-wrapper">
                            <input type="text" id="inp-etp-custom-id" class="floating-input" placeholder=" " required>
                            <label class="floating-label">Code Séance</label>
                        </div>
                    </div>
                    <div class="col-span-3">
                        <div class="input-wrapper">
                            <input type="text" id="inp-etp-title" class="floating-input" placeholder=" " required>
                            <label class="floating-label">Intitulé de la séance</label>
                        </div>
                    </div>
                </div>

                <!-- Category & Mode Row -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-gray-500 uppercase ml-1">Catégorie</label>
                        <select id="inp-etp-category"
                            class="w-full bg-gray-50 border border-gray-300 rounded p-2 text-sm focus:border-blue-500 outline-none">
                            <option value="Alimentation Saine">Alimentation Saine</option>
                            <option value="Activité Physique">Activité Physique</option>
                            <option value="Autosurveillance">Autosurveillance</option>
                            <option value="Traitement Médicamenteux">Traitement Médicamenteux</option>
                            <option value="Résolution de Problèmes">Résolution de Problèmes</option>
                            <option value="Compétences d'Adaptation">Compétences d'Adaptation</option>
                            <option value="Réduction des Risques">Réduction des Risques</option>
                        </select>
                    </div>

                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-gray-500 uppercase ml-1">Mode</label>
                        <select id="inp-etp-mode"
                            class="w-full bg-gray-50 border border-gray-300 rounded p-2 text-sm focus:border-blue-500 outline-none">
                            <option value="Individuel">Individuel</option>
                            <option value="Collectif">Collectif</option>
                        </select>
                    </div>
                </div>

                <!-- NEW: Educational Objectives -->
                <div class="space-y-1">
                    <label class="text-xs font-semibold text-gray-500 uppercase ml-1">Objectifs éducatifs</label>
                    <textarea id="inp-etp-objectives" rows="3"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 outline-none text-sm"
                        placeholder="Ex: Comprendre le mécanisme de l'insuline..."></textarea>
                </div>

                <!-- Prerequisites -->
                <div class="space-y-1">
                    <label class="text-xs font-semibold text-gray-500 uppercase ml-1">Prérequis éducatif</label>
                    <textarea id="inp-etp-prerequisites" rows="2"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 outline-none text-sm"
                        placeholder="Ex: Connaissances de base sur..."></textarea>
                </div>

                <!-- Pedagogical Content -->
                <div class="space-y-1">
                    <label class="text-xs font-semibold text-gray-500 uppercase ml-1">Contenu pédagogique</label>
                    <textarea id="inp-etp-content" rows="3"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 outline-none text-sm"
                        placeholder="Ex: Apprendre à lire les étiquettes..."></textarea>
                </div>

                <!-- Supports -->
                <div class="space-y-1">
                    <label class="text-xs font-semibold text-gray-500 uppercase ml-1">Supports / Outils</label>
                    <textarea id="inp-etp-supports" rows="2"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 outline-none text-sm"
                        placeholder="Ex: Flyer, carnet de suivi..."></textarea>
                </div>

                <div class="pt-4 flex justify-end gap-3" id="etp-modal-actions">
                    <button type="button" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
                        id="btn-cancel-etp">Annuler</button>
                    <button type="submit"
                        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-sm transition-colors"
                        id="btn-save-etp">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: MEDICATION EDITOR -->
    <div id="modal-medication" class="modal hidden">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800" id="modal-med-title">Nouveau Médicament</h3>
                <span class="close-button text-gray-400 hover:text-gray-600 cursor-pointer text-2xl"
                    id="close-modal-med">&times;</span>
            </div>
            <form id="form-medication" class="space-y-4">
                <input type="hidden" id="inp-med-id">

                <div class="grid grid-cols-2 gap-4">
                    <div class="input-wrapper">
                        <input type="text" id="inp-med-dci" class="floating-input" placeholder=" " required>
                        <label class="floating-label">DCI (Dénomination Commune)</label>
                    </div>
                    <div class="input-wrapper">
                        <input type="text" id="inp-med-commercial" class="floating-input" placeholder=" ">
                        <label class="floating-label">Nom Commercial</label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="input-wrapper relative z-20" id="wrapper-med-class">
                        <input type="text" id="inp-med-class" class="floating-input pr-8" placeholder=" "
                            autocomplete="off">
                        <label class="floating-label">Classe Thérapeutique</label>
                        <!-- Chevron Icon -->
                        <div
                            class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none">
                            <i class="fas fa-chevron-down text-xs"></i>
                        </div>
                        <!-- Custom Dropdown List -->
                        <div id="list-med-class"
                            class="absolute z-10 w-full bg-white border border-gray-200 rounded-b-lg shadow-lg max-h-48 overflow-y-auto hidden mt-1">
                        </div>
                    </div>
                    <div class="input-wrapper">
                        <input type="text" id="inp-med-route" class="floating-input" placeholder=" ">
                        <label class="floating-label">Voie d'administration</label>
                    </div>
                </div>

                <div class="input-wrapper">
                    <input type="text" id="inp-med-dosages" class="floating-input" placeholder=" ">
                    <label class="floating-label">Posologies (séparées par des virgules)</label>
                </div>

                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
                        id="btn-cancel-med">Annuler</button>
                    <button type="submit"
                        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-sm transition-colors">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="notification-container"></div>

    <script src="calculations.js"></script>
    <!-- MODALS: SYNTHESIS INFO -->

    <!-- Modal HbA1c -->
    <div id="modal-info-hba1c"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                    <span class="text-2xl">🩸</span>
                </div>
                <h3 class="text-lg leading-6 font-bold text-gray-900 mt-2 mb-4">Cible d'HbA1c</h3>
                <div class="mt-2 text-left text-sm text-gray-600 space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                    <p class="italic">La cible d'HbA1c est individualisée en fonction du profil du patient :</p>

                    <div>
                        <h4 class="font-bold text-blue-600">Pour la plupart des patients : Cible < 7 %</h4>
                                <ul class="list-disc pl-5 mt-1 space-y-1">
                                    <li><strong>
                                            < 6,5 %</strong> : Diabète nouvellement diagnostiqué (espérance de vie > 15
                                                ans, sans antécédent CV, monothérapie).</li>
                                </ul>
                    </div>

                    <div>
                        <h4 class="font-bold text-blue-600">Cas général (Cible < 8 %)</h4>
                                <ul class="list-disc pl-5 mt-1 space-y-1">
                                    <li>DT2 avec comorbidité grave avérée et/ou espérance de vie limitée (< 5 ans).</li>
                                    <li>DT2 avec complications macrovasculaires évoluées.</li>
                                    <li>DT2 > 10 ans d'évolution avec risque hypoglycémique sévère si intensification.
                                    </li>
                                </ul>
                    </div>

                    <div>
                        <h4 class="font-bold text-blue-600">Personnes âgées (> 75 ans)</h4>
                        <ul class="list-disc pl-5 mt-1 space-y-1">
                            <li><strong>"Vigoureuses"</strong> (espérance de vie satisfaisante) : Cible < 7 %.</li>
                            <li><strong>"Fragiles"</strong> (état intermédiaire) : Cible < 8 %.</li>
                            <li><strong>"Malades"</strong> (dépendantes, polypathologie) : Cible < 9 % (et/ou glycémies
                                    pré-prandiales 1-2 g/L).</li>
                        </ul>
                    </div>

                    <div>
                        <h4 class="font-bold text-blue-600">Insuffisance Rénale Chronique (IRC)</h4>
                        <ul class="list-disc pl-5 mt-1 space-y-1">
                            <li><strong>Stades 3A/3B</strong> (Modérée) : Cible < 7 %.</li>
                            <li><strong>Stades 4/5</strong> (Sévère/Terminale) : Cible < 8 %.</li>
                        </ul>
                    </div>

                    <div>
                        <h4 class="font-bold text-blue-600">Grossesse</h4>
                        <ul class="list-disc pl-5 mt-1 space-y-1">
                            <li>Avant / Durant : Cible < 6,5 %.</li>
                        </ul>
                    </div>

                    <p class="text-xs text-gray-400 mt-4 border-t pt-2">Référence : HAS - Stratégie thérapeutique du
                        patient vivant avec un diabète de type 2, mai 2024.</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button
                        class="modal-close-btn px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        Fermer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tension -->
    <div id="modal-info-ta" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <span class="text-2xl">💓</span>
                </div>
                <h3 class="text-lg leading-6 font-bold text-gray-900 mt-2 mb-4">Cible de Tension Artérielle</h3>
                <div class="mt-2 text-left text-sm text-gray-600 space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                    <p class="italic">La cible tensionnelle doit être individualisée :</p>

                    <div>
                        <h4 class="font-bold text-red-600">Adultes < 65 ans</h4>
                                <p class="text-xs mb-1">Traitement si PA ≥ 140/90 mmHg</p>
                                <ul class="list-disc pl-5 mt-1 space-y-1">
                                    <li><strong>Objectif : < 130/80 mmHg</strong> (et > 120/70 mmHg).</li>
                                </ul>
                    </div>

                    <div>
                        <h4 class="font-bold text-red-600">65 à 80 ans (sans fragilités)</h4>
                        <p class="text-xs mb-1">Traitement si PA ≥ 140/90 mmHg</p>
                        <ul class="list-disc pl-5 mt-1 space-y-1">
                            <li><strong>Objectif : < 140/90 mmHg</strong> (et > 130/80 mmHg).</li>
                        </ul>
                    </div>

                    <div>
                        <h4 class="font-bold text-red-600">≥ 80 ans (sans fragilité)</h4>
                        <p class="text-xs mb-1">Traitement si PA ≥ 160/90 mmHg</p>
                        <ul class="list-disc pl-5 mt-1 space-y-1">
                            <li><strong>Objectif : < 150/90 mmHg</strong> (sans hypotension orthostatique).</li>
                        </ul>
                    </div>

                    <div>
                        <h4 class="font-bold text-red-600">Avec fragilité (tout âge)</h4>
                        <p class="text-xs mb-1">Traitement si PA ≥ 160/90 mmHg</p>
                        <ul class="list-disc pl-5 mt-1 space-y-1">
                            <li><strong>Objectif : < 150/90 mmHg</strong> (sans hypotension orthostatique).</li>
                        </ul>
                    </div>

                    <p class="text-xs text-gray-400 mt-4 border-t pt-2">Référence : 2023 ESC Guidelines for the
                        management of cardiovascular disease in patients with diabetes.</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button
                        class="modal-close-btn px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        Fermer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal LDL -->
    <div id="modal-info-ldl" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                    <span class="text-2xl">📊</span>
                </div>
                <h3 class="text-lg leading-6 font-bold text-gray-900 mt-2 mb-4">Cible de LDL Cholestérol</h3>
                <div class="mt-2 text-left text-sm text-gray-600 space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                    <p class="italic">Le choix de la cible dépend du niveau de risque cardiovasculaire :</p>

                    <div class="bg-yellow-50 p-2 rounded border border-yellow-100">
                        <h4 class="font-bold text-yellow-700 mb-1">Prévention Secondaire / AOC Sévère</h4>
                        <ul class="list-none space-y-1">
                            <li class="font-bold text-lg text-center text-yellow-800">Objectif : < 0.55 g/L</li>
                        </ul>
                        <p class="text-xs mt-1 text-yellow-600">Note : AOC sévère inclut DFG < 45, ou Microalbuminurie +
                                DFG 45-59, ou Macroalbuminurie.</p>
                    </div>

                    <div>
                        <h4 class="font-bold text-gray-700">Prévention Primaire (selon SCORE2-Diabète)</h4>
                        <table class="w-full text-xs mt-2 border-collapse">
                            <tr class="border-b">
                                <td class="py-1 pr-2 font-semibold">Risque FAIBLE (< 5%)</td>
                                <td class="py-1 text-right font-bold text-green-600">
                                    < 1.6 g/L</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 pr-2 font-semibold">Risque MODÉRÉ (5-10%)</td>
                                <td class="py-1 text-right font-bold text-yellow-600">
                                    < 1.0 g/L</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-1 pr-2 font-semibold">Risque ÉLEVÉ (10-20%)</td>
                                <td class="py-1 text-right font-bold text-orange-600">
                                    < 0.70 g/L</td>
                            </tr>
                            <tr>
                                <td class="py-1 pr-2 font-semibold">Risque TRÈS ÉLEVÉ (> 20%)</td>
                                <td class="py-1 text-right font-bold text-red-600">
                                    < 0.55 g/L</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="items-center px-4 py-3">
                    <button
                        class="modal-close-btn px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        Fermer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="data/medications.js"></script>
    <script src="pharma_book.js"></script>
    <script src="data/education_topics.js"></script>
    <script src="calculations.js"></script>
    <script src="summary_engine.js"></script>
    <script type="module" src="renderer.js"></script>
</body>

</html>